{
  "variables":{
    "aws_access_key":"",
    "aws_secret_key":"",
    "aws_account_id":"5586-1770-0099",
    "security_group_id":"sg-e6908584",
    "aws_s3_bucket":"im7-backup/instance-jenkins-empty"
  },
  "builders":[
    {
      "name": "ubuntu-1404-hvm-is-jenkins",
      "type":"amazon-instance",
      "access_key":"{{user `aws_access_key`}}",
      "secret_key":"{{user `aws_secret_key`}}",
      "region":"us-west-2",
      "source_ami":"ami-29ebb519",
      "instance_type":"m3.medium",
      "ssh_username":"ubuntu",
      "account_id":"{{user `aws_account_id`}}",
      "s3_bucket":"{{user `aws_s3_bucket`}}",
      "x509_cert_path":"../../aws/x509-cert-PCRDUHIXZP4OQZRJFSDG5I6ZNE2UU4R4.pem",
      "x509_key_path":"../../aws/x509-pk-PCRDUHIXZP4OQZRJFSDG5I6ZNE2UU4R4.pem",
      "x509_upload_path":"/tmp",
      "ami_virtualization_type": "hvm",

      "bundle_vol_command": "sudo -n bash -c ' export JAVA_HOME=/usr/local/java/jdk1.8.0_05 ; export PATH=$PATH:/sbin:/usr/sbin:/usr/local/sbin:$JAVA_HOME/bin ; /usr/local/ec2/bin/ec2-bundle-vol -k {{.KeyPath}} -u {{.AccountId}} -c {{.CertPath}} -r {{.Architecture}} -e {{.PrivatePath}}/*,/usr/local/ec2*,/usr/local/java/,/usr/local/ami*,/usr/local/api* -d {{.Destination}} -p {{.Prefix}}  --block-device-mapping ami=sda,root=/dev/sda1 --batch'",

      "bundle_upload_command": "sudo -n bash -c ' export JAVA_HOME=/usr/local/java/jdk1.8.0_05 ; export PATH=$PATH:/sbin:/usr/sbin:/usr/local/sbin:$JAVA_HOME/bin ; /usr/local/ec2/bin/ec2-upload-bundle -b {{.BucketName}} -m {{.ManifestPath}} -a {{.AccessKey}} -s {{.SecretKey}} -d {{.BundleDirectory}} --batch --region {{.Region}} --retry'",

      "ami_name":"14.04-jenkins-instance-{{isotime | clean_ami_name}}",
      "security_group_id":"",
      "tags": {
        "Name": "14.04-Jenkins (Instance)-{{isotime | clean_ami_name}}"
      }
    }
  ],
  "provisioners":[
    {
      "type":"shell",
           "execute_command": "echo 'ubuntu' | {{ .Vars }} sudo -E -S sh '{{ .Path }}'",
           "scripts":[
               "setup_ubuntu_hvm_instance_store_images.sh"
          ]
      },
    {
   "type": "shell",
      "inline": [
      "sleep 10",
      "echo ***INSTALLING TOOL",
      "sudo apt-get update",  
      "sudo apt-get install -y --force-yes curl wget ",  
      "sudo apt-get install -y --force-yes curl git ",  
      "sudo apt-get install -y --force-yes curl mosh ",
      "sudo apt-get install -y --force-yes curl lynx ",
      "sudo apt-get install -y --force-yes curl unzip ",  
      "sudo apt-get install -y --force-yes curl docker.io",  
      "which lynx mosh git vi wget unzip docker",
      "echo ***INSTALLING JAVA ",
      "sudo apt-get install -y openjdk-7-jdk",
      "java -version",
      "echo ***INSTALLING JENKINS",
      "wget -q -O - https://jenkins-ci.org/debian/jenkins-ci.org.key | sudo apt-key add -",
      "sudo sh -c 'echo deb http://pkg.jenkins-ci.org/debian binary/ > /etc/apt/sources.list.d/jenkins.list'",
      "sudo apt-get update",
      "sudo apt-get install -y jenkins",
      "curl -Lo- https://bit.ly/janus-bootstrap | bash",
      "sudo service jenkins status"
     ]
   }
 ]
}

